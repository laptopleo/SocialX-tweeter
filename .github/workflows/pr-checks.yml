name: ğŸ” PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # ValidaciÃ³n de tÃ­tulo del PR
  # ============================================
  pr-title:
    name: ğŸ“ Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  # ============================================
  # AnÃ¡lisis de cambios
  # ============================================
  changes:
    name: ğŸ“Š Analyze Changes
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: ğŸ“ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const fileCount = changedFiles.length;
            
            const comment = `
            ## ğŸ“Š PR Analysis
            
            - **Files changed:** ${fileCount}
            - **Lines added:** +${{ steps.changed-files.outputs.added_files_count }}
            - **Lines deleted:** -${{ steps.changed-files.outputs.deleted_files_count }}
            
            ### ğŸ“ Changed Files:
            ${changedFiles.map(f => `- \`${f}\``).join('\n')}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # VerificaciÃ³n de tamaÃ±o del bundle
  # ============================================
  bundle-size:
    name: ğŸ“¦ Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ—ï¸ Build
        run: pnpm build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "## ğŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Output:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh .next >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Largest Files:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find .next -type f -exec du -h {} + | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # VerificaciÃ³n de dependencias
  # ============================================
  dependencies:
    name: ğŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ” Check for duplicate dependencies
        run: |
          pnpm list --depth=0 > dependencies.txt
          echo "## ğŸ“¦ Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dependencies.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Check for outdated packages
        run: pnpm outdated || true
