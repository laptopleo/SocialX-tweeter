name: ğŸ” PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  # ============================================
  # ValidaciÃ³n de tÃ­tulo del PR
  # ============================================
  pr-title:
    name: ğŸ“ Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Check PR title format
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  # ============================================
  # AnÃ¡lisis de cambios
  # ============================================
  changes:
    name: ğŸ“Š Analyze Changes
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“Š Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: ğŸ“ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const fileCount = changedFiles.length;
            
            const comment = `
            ## ğŸ“Š PR Analysis
            
            - **Files changed:** ${fileCount}
            - **Lines added:** +${{ steps.changed-files.outputs.added_files_count }}
            - **Lines deleted:** -${{ steps.changed-files.outputs.deleted_files_count }}
            
            ### ğŸ“ Changed Files:
            ${changedFiles.map(f => `- \`${f}\``).join('\n')}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # VerificaciÃ³n de tamaÃ±o del bundle
  # ============================================
  bundle-size:
    name: ğŸ“¦ Bundle Size Check
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      # Pusher
      PUSHER_APP_ID: ${{ secrets.PUSHER_APP_ID }}
      PUSHER_KEY: ${{ secrets.PUSHER_KEY }}
      PUSHER_SECRET: ${{ secrets.PUSHER_SECRET }}
      PUSHER_CLUSTER: ${{ secrets.PUSHER_CLUSTER }}
      NEXT_PUBLIC_PUSHER_KEY: ${{ secrets.NEXT_PUBLIC_PUSHER_KEY }}
      NEXT_PUBLIC_PUSHER_CLUSTER: ${{ secrets.NEXT_PUBLIC_PUSHER_CLUSTER }}
      # Otros servicios
      STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      NEXT_PUBLIC_TENOR_API_KEY: ${{ secrets.NEXT_PUBLIC_TENOR_API_KEY }}
      NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ›¡ï¸ Verify Required Secrets
        run: |
          REQUIRED_SECRETS=(
            "DATABASE_URL"
            "DIRECT_DATABASE_URL"
            "AUTH_SECRET"
            "NEXT_PUBLIC_APP_URL"
            "PUSHER_APP_ID"
            "PUSHER_KEY"
            "PUSHER_SECRET"
            "PUSHER_CLUSTER"
            "NEXT_PUBLIC_PUSHER_KEY"
            "NEXT_PUBLIC_PUSHER_CLUSTER"
            "STRIPE_API_KEY"
            "STRIPE_WEBHOOK_SECRET"
            "GEMINI_API_KEY"
            "NEXT_PUBLIC_TENOR_API_KEY"
            "NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY"
          )

          MISSING_SECRETS=()
          for SECRET in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!SECRET}" ]; then
              MISSING_SECRETS+=("$SECRET")
            fi
          done

          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "âŒ Error: Faltan los siguientes secretos requeridos:"
            for SECRET in "${MISSING_SECRETS[@]}"; do
              echo "  - $SECRET"
            done
            exit 1
          else
            echo "âœ… Todos los secretos requeridos estÃ¡n presentes."
          fi

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build
        run: pnpm build

      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "## ğŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Output:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh .next >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Largest Files:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find .next -type f -exec du -h {} + | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # VerificaciÃ³n de dependencias
  # ============================================
  dependencies:
    name: ğŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: ğŸ” Check for duplicate dependencies
        run: |
          pnpm list --depth=0 > dependencies.txt
          echo "## ğŸ“¦ Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dependencies.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Check for outdated packages
        run: pnpm outdated || true
