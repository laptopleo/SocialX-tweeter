name: ðŸš€ CD - Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Prevenir deploys concurrentes
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # ============================================
  # Pre-Deploy Validation
  # ============================================
  pre-deploy:
    name: ðŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”· TypeScript check
        run: npx tsc --noEmit

      - name: ðŸ” Lint check
        run: pnpm lint

      - name: ðŸ—„ï¸ Prisma validation
        run: npx prisma validate

      - name: ðŸ—ï¸ Build test
        run: pnpm build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

  # ============================================
  # Database Backup
  # ============================================
  backup:
    name: ðŸ—„ï¸ Database Backup
    runs-on: ubuntu-latest
    needs: pre-deploy
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—„ï¸ Create backup
        run: |
          mkdir -p backups
          npx prisma db pull --force
          echo "âœ… Schema backup created"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ’¾ Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.sha }}
          path: prisma/schema.prisma
          retention-days: 30

  # ============================================
  # Deploy to Vercel
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [pre-deploy, backup]
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—„ï¸ Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-Deploy Health Check
  # ============================================
  health-check:
    name: ðŸ¥ Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¥ Wait for deployment
        run: sleep 30

      - name: ðŸ” Check homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.NEXT_PUBLIC_APP_URL }})
          if [ $response -eq 200 ]; then
            echo "âœ… Homepage is accessible"
          else
            echo "âŒ Homepage returned status code: $response"
            exit 1
          fi

      - name: ðŸ” Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.NEXT_PUBLIC_APP_URL }}/api/health || echo "404")
          echo "API health check returned: $response"
          # No fallar si el endpoint no existe
          echo "âœ… Health check completed"

      - name: ðŸ“Š Health check summary
        run: |
          echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All health checks passed" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Notify Success
  # ============================================
  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: success()

    steps:
      - name: ðŸŽ‰ Success notification
        run: |
          echo "## ðŸŽ‰ Deployment Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pre-deploy validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database backup created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ secrets.NEXT_PUBLIC_APP_URL }}" >> $GITHUB_STEP_SUMMARY
