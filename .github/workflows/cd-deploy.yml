name: ðŸš€ CD - Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Prevenir deploys concurrentes
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # ============================================
  # Pre-Deploy Validation
  # ============================================
  pre-deploy:
    name: ðŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
      # Pusher
      PUSHER_APP_ID: ${{ secrets.PUSHER_APP_ID }}
      PUSHER_KEY: ${{ secrets.PUSHER_KEY }}
      PUSHER_SECRET: ${{ secrets.PUSHER_SECRET }}
      PUSHER_CLUSTER: ${{ secrets.PUSHER_CLUSTER }}
      NEXT_PUBLIC_PUSHER_KEY: ${{ secrets.NEXT_PUBLIC_PUSHER_KEY }}
      NEXT_PUBLIC_PUSHER_CLUSTER: ${{ secrets.NEXT_PUBLIC_PUSHER_CLUSTER }}
      # Otros servicios
      STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      NEXT_PUBLIC_TENOR_API_KEY: ${{ secrets.NEXT_PUBLIC_TENOR_API_KEY }}
      NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ›¡ï¸ Verify Required Secrets
        run: |
          REQUIRED_SECRETS=(
            "DATABASE_URL"
            "DIRECT_DATABASE_URL"
            "AUTH_SECRET"
            "NEXT_PUBLIC_APP_URL"
            "PUSHER_APP_ID"
            "PUSHER_KEY"
            "PUSHER_SECRET"
            "PUSHER_CLUSTER"
            "NEXT_PUBLIC_PUSHER_KEY"
            "NEXT_PUBLIC_PUSHER_CLUSTER"
            "STRIPE_API_KEY"
            "STRIPE_WEBHOOK_SECRET"
            "GEMINI_API_KEY"
            "NEXT_PUBLIC_TENOR_API_KEY"
            "NEXT_PUBLIC_UPLOADCARE_PUBLIC_KEY"
          )

          MISSING_SECRETS=()
          for SECRET in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!SECRET}" ]; then
              MISSING_SECRETS+=("$SECRET")
            fi
          done

          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "âŒ Error: Faltan los siguientes secretos requeridos:"
            for SECRET in "${MISSING_SECRETS[@]}"; do
              echo "  - $SECRET"
            done
            exit 1
          else
            echo "âœ… Todos los secretos requeridos estÃ¡n presentes."
          fi


      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”· TypeScript check
        run: npx tsc --noEmit

      - name: ðŸ” Lint check
        run: pnpm lint

      - name: ðŸ—„ï¸ Prisma validation
        run: npx prisma validate

      - name: ðŸ—ï¸ Build test
        run: pnpm build

  # ============================================
  # Database Backup
  # ============================================
  backup:
    name: ðŸ—„ï¸ Database Backup
    runs-on: ubuntu-latest
    needs: pre-deploy
    timeout-minutes: 10
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—„ï¸ Create backup
        run: |
          mkdir -p backups
          npx prisma db pull --force
          echo "âœ… Schema backup created"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ’¾ Upload backup artifact
        uses: actions/upload-artifact@v6
        with:
          name: db-backup-${{ github.sha }}
          path: prisma/schema.prisma
          retention-days: 30

  # ============================================
  # Deploy to Vercel
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [pre-deploy, backup]
    timeout-minutes: 20
    env:  
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—„ï¸ Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-Deploy Health Check
  # ============================================
  health-check:
    name: ðŸ¥ Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ¥ Wait for deployment
        run: sleep 30

      - name: ðŸ” Check homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.NEXT_PUBLIC_APP_URL }})
          if [ $response -eq 200 ]; then
            echo "âœ… Homepage is accessible"
          else
            echo "âŒ Homepage returned status code: $response"
            exit 1
          fi

      - name: ðŸ” Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.NEXT_PUBLIC_APP_URL }}/api/health || echo "404")
          echo "API health check returned: $response"
          # No fallar si el endpoint no existe
          echo "âœ… Health check completed"

      - name: ðŸ“Š Health check summary
        run: |
          echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All health checks passed" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Notify Success
  # ============================================
  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: success()

    steps:
      - name: ðŸŽ‰ Success notification
        run: |
          echo "## ðŸŽ‰ Deployment Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pre-deploy validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database backup created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ secrets.NEXT_PUBLIC_APP_URL }}" >> $GITHUB_STEP_SUMMARY
